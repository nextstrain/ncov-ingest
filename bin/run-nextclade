#!/usr/bin/env bash

# Downloads data required for Nextclade to function and runs nextclade

set -o errexit
set -o nounset
set -o pipefail
trap "exit" INT

: "${1:?\"[ERROR] ${0}: Input fasta filename as the 1st argument is required.\"}"
: "${2:?\"[ERROR] ${0}: Output TSV filename as the 2nd argument is required.\"}"
: "${3:?\"[ERROR] ${0}: Directory for Nextclade input data as the 3rd argument is required.\"}"
: "${4:?\"[ERROR] ${0}: Output directory as the 4th argument is required.\"}"

INPUT_FASTA="${1}"
OUTPUT_TSV="${2}"
NEXTCLADE_DATASET_DIR="${3}" # external data required for nextclade to function will be downloaded there
NEXTCLADE_OUTPUTS_DIR="${4}" # files other than TSV will be written by Nextclade there (aligned sequences, peptides, etc.)

echo "[ INFO] ${0}:${LINENO}: Downloading latest Nextclade version"
curl -fsSL "https://github.com/nextstrain/nextclade/releases/latest/download/nextclade-Linux-x86_64" -o "nextclade"
chmod +x nextclade

if ! command -v ./nextclade &>/dev/null; then
  echo "[ERROR] ${0}:${LINENO}: Nextclade executable not found"
  exit 1
fi

NEXTCLADE_VERSION="$(./nextclade --version)"
echo "[ INFO] ${0}:${LINENO}: Nextclade version: ${NEXTCLADE_VERSION}"

echo "[ INFO] ${0}:${LINENO}: Downloading Nextclade dataset \"sars-cov-2\""
./nextclade dataset get --name=sars-cov-2 --output-dir="${NEXTCLADE_DATASET_DIR}" --verbose


echo "[ INFO] ${0}:${LINENO}: Running Nextclade"
./nextclade run \
  --in-order \
  --verbosity=error \
  --input-fasta="${INPUT_FASTA}" \
  --input-dataset="${NEXTCLADE_DATASET_DIR}" \
  --output-tsv="${OUTPUT_TSV}" \
  --genes=E,M,N,ORF1a,ORF1b,ORF3a,ORF6,ORF7a,ORF7b,ORF8,ORF9b,S \
  --output-dir="${NEXTCLADE_OUTPUTS_DIR}" \
  --output-basename="nextclade"

#!/usr/bin/env bash

set -euxo pipefail
trap "exit" INT

DOCKER_IMAGE_NAME="nextstrain/ncov-ingest"
DOCKER_CONTAINER_NAME="${DOCKER_IMAGE_NAME//\//-}-$(TZ=UTC date "+%Y-%m-%d--%H-%M-%S--%Z")"

GITHUB_BRANCH=$(git rev-parse --abbrev-ref HEAD) || "unknown"

declare -a config
config+=(
  database_name="gisaid"
  s3_src="s3://nextstrain-ncov-private/branch/${GITHUB_BRANCH}"
  s3_dst="s3://nextstrain-ncov-private/branch/${GITHUB_BRANCH}"
  fetch_from_database=false
  trigger_preprocessing=false
  keep_all_files: true
)

# shellcheck disable=SC2124
DEFAULT_COMMAND="\
  snakemake \
  --config ${config[@]} \
  --cores all \
  --printshellcmds \
  --show-failed-logs \
"

COMMAND="${*:-${DEFAULT_COMMAND}}"

docker build -t ${DOCKER_IMAGE_NAME}:latest .

mkdir -p .cache

docker run -it --rm \
  --init \
  --name="${DOCKER_CONTAINER_NAME}" \
  --hostname="${DOCKER_IMAGE_NAME}" \
  --user="$(id -u):$(id -g)" \
  --volume="$(pwd):/workdir" \
  --volume="$(pwd)/.cache:/.cache" \
  --workdir=/workdir \
  ${DOCKER_IMAGE_NAME} \
  envdir env.d ${COMMAND}
